{% extends 'base.html' %}

{% block title %}Coordinator Dashboard{% endblock %}

{% block extra_head %}
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
    <style>
        @media (min-width: 768px) {
            .sidebar {
                position: sticky;
                top: 1rem;
                height: calc(100vh - 2rem);
                overflow-y: auto;
            }
        }
        .form-label {
            font-weight: 500;
        }
        /* Estilos para que Tom Select sea scrollable horizontalmente */
        .ts-control {
            overflow-x: auto;
            flex-wrap: nowrap !important;
        }
        .ts-wrapper.multi .ts-control > div {
            flex-shrink: 0;
        }
    </style>
{% endblock %}

{% block content %}
    <h2 class="my-4">Coordinator Dashboard</h2>

    {% if show_no_titulaciones_message %}
        <div class="alert alert-warning" role="alert">
            You are not assigned to any titulaciones. Please contact an administrator.
        </div>
    {% else %}
    <div class="row">
        <div class="col-md-3">
            <div class="sidebar p-3 bg-light rounded">
                <h3 class="mb-3">Filter Activities</h3>
                <form method="get" action="{% url 'coordinator_dashboard' %}" id="filter-form">
                    
                    <div class="mb-3">
                        <label for="titulacion" class="form-label">Titulacion:</label>
                        <select name="titulacion" id="titulacion" multiple>
                            {% for titulacion in titulaciones %}
                                <option value="{{ titulacion.id }}" {% if titulacion.id|stringformat:"s" in selected_titulaciones %}selected{% endif %}>{{ titulacion.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="row">
                        <div class="col-6">
                            <div class="mb-3">
                                <label for="curso" class="form-label">Curso:</label>
                                <select name="curso" id="curso" multiple class="form-select">
                                    {% for curso in cursos %}
                                        <option value="{{ curso }}" {% if curso|stringformat:"s" in selected_cursos %}selected{% endif %}>{{ curso }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-3">
                                <label for="semestre" class="form-label">Semestre:</label>
                                <select name="semestre" id="semestre" multiple class="form-select">
                                    {% for semestre in semestres %}
                                        <option value="{{ semestre }}" {% if semestre|stringformat:"s" in selected_semestres %}selected{% endif %}>{{ semestre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="accordion" id="advancedFilters">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingAcademicos">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAcademicos" aria-expanded="false" aria-controls="collapseAcademicos">
                                    Detalles Académicos
                                </button>
                            </h2>
                            <div id="collapseAcademicos" class="accordion-collapse collapse" aria-labelledby="headingAcademicos" data-bs-parent="#advancedFilters">
                                <div class="accordion-body">
                                    <div class="mb-3">
                                        <label for="asignatura" class="form-label">Asignatura:</label>
                                        <select name="asignatura" id="asignatura" multiple>
                                            {% for asignatura in asignaturas %}
                                                <option value="{{ asignatura.id }}" {% if asignatura.id|stringformat:"s" in selected_asignaturas %}selected{% endif %}>{{ asignatura.nombre }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="tipo_actividad" class="form-label">Activity Type:</label>
                                        <select name="tipo_actividad" id="tipo_actividad" multiple class="form-select">
                                            {% for tipo in tipos_actividad %}
                                                <option value="{{ tipo.id }}" {% if tipo.id|stringformat:"s" in selected_tipos_actividad %}selected{% endif %}>{{ tipo.nombre }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingEvaluacion">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEvaluacion" aria-expanded="false" aria-controls="collapseEvaluacion">
                                    Atributos y Estado
                                </button>
                            </h2>
                            <div id="collapseEvaluacion" class="accordion-collapse collapse" aria-labelledby="headingEvaluacion" data-bs-parent="#advancedFilters">
                                <div class="accordion-body">
                                    <div class="form-check mb-3">
                                        <input type="checkbox" id="filter_evaluable" name="filter_evaluable" class="form-check-input" {% if filter_evaluable %}checked{% endif %}>
                                        <label for="filter_evaluable" class="form-check-label">Show Evaluable Activities</label>
                                    </div>
                                    <div class="mb-3">
                                        <label for="min_percentage" class="form-label">Min. Percentage:</label>
                                        <input type="number" id="min_percentage" name="min_percentage" value="{{ min_percentage|default:'' }}" step="0.01" min="0" max="100" class="form-control">
                                    </div>
                                    <div class="mb-3">
                                        <label for="approval_status" class="form-label">Approval Status:</label>
                                        <select name="approval_status" id="approval_status" class="form-select">
                                            <option value="all" {% if approval_status == 'all' %}selected{% endif %}>All</option>
                                            <option value="approved" {% if approval_status == 'approved' %}selected{% endif %}>Approved</option>
                                            <option value="unapproved" {% if approval_status == 'unapproved' %}selected{% endif %}>Unapproved</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex mt-4">
                        <button type="submit" class="btn btn-primary w-100">Filter</button>
                        <a href="{% url 'coordinator_dashboard' %}" class="btn btn-outline-secondary ms-2" title="Clear Filters">✖</a>
                    </div>
                </form>
            </div>
        </div>
        <div class="col-md-9">
             <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list-view" type="button" role="tab" aria-controls="list-view" aria-selected="true">Activity List</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#calendar-view" type="button" role="tab" aria-controls="calendar-view" aria-selected="false">Calendar View</button>
                </li>
            </ul>

            <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade show active" id="list-view" role="tabpanel" aria-labelledby="list-tab">
                    <div class="p-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3 class="mb-0">Filtered Activities</h3>
                            <span class="badge bg-secondary rounded-pill">{{ activities|length }} found</span>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Activity Name</th><th>Subjects</th><th>Type</th><th>Start Date</th><th>End Date</th><th>Evaluable</th><th>Percentage</th><th>Approved</th><th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for activity in activities %}
                                    <tr>
                                        <td>{{ activity.nombre }}</td>
                                        <td>{% for asignatura in activity.asignaturas.all %}{{ asignatura.nombre }}{% if not forloop.last %}, {% endif %}{% endfor %}</td>
                                        <td>{{ activity.tipo_actividad.nombre }}</td>
                                        <td>{{ activity.fecha_inicio }}</td>
                                        <td>{{ activity.fecha_fin }}</td>
                                        <td><input type="checkbox" {% if activity.evaluable %}checked{% endif %} disabled></td>
                                        <td>{{ activity.porcentaje_evaluacion }}%</td>
                                        <td>
                                            {% with can_edit=False %}{% for asignatura in activity.asignaturas.all %}{% if asignatura.titulacion.id|stringformat:"s" in user_coordinated_titulaciones_ids %}{% with can_edit=True %}{% endwith %}{% endif %}{% endfor %}{% endwith %}
                                            <input type="checkbox" class="form-check-input approval-checkbox" data-activity-id="{{ activity.id }}" {% if activity.aprobada %}checked{% endif %} {% if not can_edit %}disabled{% endif %}>
                                        </td>
                                        <td>
                                            <a href="{% url 'activity_edit' activity.id %}" class="btn btn-sm btn-info">Edit</a>
                                            <a href="{% url 'activity_delete' activity.id %}" class="btn btn-sm btn-danger ms-1">Delete</a>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="9" class="text-center">No activities found.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="calendar-view" role="tabpanel" aria-labelledby="calendar-tab">
                    <div class="p-3">
                         <h3 class="mb-3">Calendar</h3>
                        <div id='calendar'></div>
                    </div>
                </div>
            </div>
        </div>
        </div>
    {% endif %}

    <p class="mt-4">
        <form action="{% url 'logout' %}" method="post" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-secondary">Logout</button>
        </form>
    </p>
{% endblock %}

{% block extra_js %}
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- 3. Inicialización de Tom Select ---
        new TomSelect('#titulacion',{ plugins: ['remove_button'], create: false });
        new TomSelect('#asignatura',{ plugins: ['remove_button'], create: false });
        // Los otros selectores no se transforman para mantener su UI simple
        
        // --- LÓGICA DEL CALENDARIO (CORREGIDA) ---
        var calendarEl = document.getElementById('calendar');
        var isCalendarRendered = false;
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
            events: function(fetchInfo, successCallback, failureCallback) {
                const params = new URLSearchParams(new FormData(document.getElementById('filter-form')));
                fetch(`/all_activities/?${params.toString()}`)
                    .then(response => response.json()).then(data => successCallback(data)).catch(error => failureCallback(error));
            }
        });

        var calendarTab = document.getElementById('calendar-tab');
        calendarTab.addEventListener('shown.bs.tab', function (event) {
            if (!isCalendarRendered) {
                calendar.render();
                isCalendarRendered = true;
            } else {
                calendar.refetchEvents();
            }
        });

        // --- RESTO DEL SCRIPT ---
        document.querySelectorAll('.approval-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const activityId = this.dataset.activityId;
                const isApproved = this.checked;
                fetch(`/activity/toggle_approval_from_dashboard/${activityId}/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 'aprobada': isApproved })
                })
                .then(response => response.json()).then(data => { if (!data.success) { alert('Failed to update status'); this.checked = !isApproved; } })
                .catch(error => { alert('Error toggling status.'); this.checked = !isApproved; });
            });
        });

        const titulacionSelect = document.getElementById('titulacion');
        const cursoSelect = document.getElementById('curso');
        const asignaturaSelect = document.getElementById('asignatura');

        function updateAsignaturas() {
            // Tom Select usa un objeto API, así que obtenemos los valores de su instancia
            const tsTitulacion = titulacionSelect.tomselect;
            const selectedTitulaciones = tsTitulacion.getValue();
            
            const selectedCursos = Array.from(cursoSelect.selectedOptions).map(option => option.value);
            const params = new URLSearchParams();
            selectedTitulaciones.forEach(id => params.append('titulacion_ids', id));
            selectedCursos.forEach(id => params.append('curso_ids', id));
            fetch(`/ajax/get_filtered_asignaturas/?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    const tsAsignatura = asignaturaSelect.tomselect;
                    const selected = tsAsignatura.getValue();
                    tsAsignatura.clearOptions();
                    tsAsignatura.addOptions(data.map(asignatura => ({value: asignatura.id, text: asignatura.nombre})));
                    tsAsignatura.setValue(selected); // Re-seleccionar lo que estuviera antes si aún existe
                });
        }

        if (titulacionSelect.tomselect && cursoSelect) {
            titulacionSelect.tomselect.on('change', updateAsignaturas);
            cursoSelect.addEventListener('change', updateAsignaturas);
            updateAsignaturas();
        }

        document.getElementById('filter-form').addEventListener('submit', function() {
            const btn = this.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Filtering...`;
        });
    });
    </script>
{% endblock %}