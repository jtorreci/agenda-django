{% extends 'base.html' %}

{% block title %}Coordinator Dashboard{% endblock %}

{% block extra_head %}
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
    <style>
        @media (min-width: 768px) {
            .sidebar {
                position: sticky;
                top: 1rem;
                height: calc(100vh - 2rem);
                overflow-y: auto;
            }
        }
        .form-label {
            font-weight: 500;
        }
        /* Estilos para que Tom Select sea scrollable horizontalmente */
        .ts-control {
            overflow-x: auto;
            flex-wrap: nowrap !important;
        }
        .ts-wrapper.multi .ts-control > div {
            flex-shrink: 0;
        }
        
        /* Estilos para checkboxes de aprobación */
        .approval-checkbox:disabled {
            opacity: 0.6;
            cursor: not-allowed !important;
        }
        
        .approval-checkbox:not(:disabled):hover {
            transform: scale(1.1);
            transition: transform 0.1s ease;
        }
        
        .approval-cell {
            text-align: center;
            position: relative;
        }
        
        /* Tooltip mejorado */
        .approval-checkbox[title]:hover::after {
            content: attr(title);
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 5px;
        }
    </style>
{% endblock %}

{% block content %}
    <h2 class="my-4">Coordinator Dashboard</h2>

    {% if show_no_titulaciones_message %}
        <div class="alert alert-warning" role="alert">
            You are not assigned to any titulaciones. Please contact an administrator.
        </div>
    {% else %}
    <div class="row">
        <div class="col-md-3">
            <div class="sidebar p-3 bg-light rounded">
                <h3 class="mb-3">Filter Activities</h3>
                <form method="get" action="{% url 'coordinator_dashboard' %}" id="filter-form">
                    
                    <div class="mb-3">
                        <label for="titulacion" class="form-label">Titulacion:</label>
                        <select name="titulacion" id="titulacion" multiple>
                            {% for titulacion in titulaciones %}
                                <option value="{{ titulacion.id }}" {% if titulacion.id|stringformat:"s" in selected_titulaciones %}selected{% endif %}>{{ titulacion.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="row">
                        <div class="col-6">
                            <div class="mb-3">
                                <label for="curso" class="form-label">Curso:</label>
                                <select name="curso" id="curso" multiple>
                                    {% for curso in cursos %}
                                        <option value="{{ curso.value }}" {% if curso.value|stringformat:"s" in selected_cursos %}selected{% endif %}>{{ curso.label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-3">
                                <label for="semestre" class="form-label">Semestre:</label>
                                <select name="semestre" id="semestre" multiple>
                                    {% for semestre in semestres %}
                                        <option value="{{ semestre }}" {% if semestre|stringformat:"s" in selected_semestres %}selected{% endif %}>{{ semestre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="accordion" id="advancedFilters">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingAcademicos">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAcademicos" aria-expanded="false" aria-controls="collapseAcademicos">
                                    Detalles Académicos
                                </button>
                            </h2>
                            <div id="collapseAcademicos" class="accordion-collapse collapse" aria-labelledby="headingAcademicos" data-bs-parent="#advancedFilters">
                                <div class="accordion-body">
                                    <div class="mb-3">
                                        <label for="asignatura" class="form-label">Asignatura:</label>
                                        <select name="asignatura" id="asignatura" multiple>
                                            {% for asignatura in asignaturas %}
                                                <option value="{{ asignatura.id }}" {% if asignatura.id|stringformat:"s" in selected_asignaturas %}selected{% endif %}>{{ asignatura.nombre }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="tipo_actividad" class="form-label">Activity Type:</label>
                                        <select name="tipo_actividad" id="tipo_actividad" multiple class="form-select">
                                            {% for tipo in tipos_actividad %}
                                                <option value="{{ tipo.id }}" {% if tipo.id|stringformat:"s" in selected_tipos_actividad %}selected{% endif %}>{{ tipo.nombre }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingEvaluacion">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEvaluacion" aria-expanded="false" aria-controls="collapseEvaluacion">
                                    Atributos y Estado
                                </button>
                            </h2>
                            <div id="collapseEvaluacion" class="accordion-collapse collapse" aria-labelledby="headingEvaluacion" data-bs-parent="#advancedFilters">
                                <div class="accordion-body">
                                    <div class="form-check mb-3">
                                        <input type="checkbox" id="filter_evaluable" name="filter_evaluable" class="form-check-input" {% if filter_evaluable %}checked{% endif %}>
                                        <label for="filter_evaluable" class="form-check-label">Show Evaluable Activities</label>
                                    </div>
                                    <div class="mb-3">
                                        <label for="min_percentage" class="form-label">Min. Percentage:</label>
                                        <input type="number" id="min_percentage" name="min_percentage" value="{{ min_percentage|default:'' }}" step="0.01" min="0" max="100" class="form-control">
                                    </div>
                                    <div class="mb-3">
                                        <label for="approval_status" class="form-label">Approval Status:</label>
                                        <select name="approval_status" id="approval_status" class="form-select">
                                            <option value="all" {% if approval_status == 'all' %}selected{% endif %}>All</option>
                                            <option value="approved" {% if approval_status == 'approved' %}selected{% endif %}>Approved</option>
                                            <option value="unapproved" {% if approval_status == 'unapproved' %}selected{% endif %}>Unapproved</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex mt-4">
                        <button type="submit" class="btn btn-primary w-100">Filter</button>
                        <a href="{% url 'coordinator_dashboard' %}" class="btn btn-outline-secondary ms-2" title="Clear Filters">✖</a>
                    </div>
                </form>
                <hr class="my-4">
                <div class="d-grid gap-2">
                    <a href="{% url 'activity_logs' %}" class="btn btn-outline-info">View Activity Logs</a>
                    <div class="dropdown">
                        <button class="btn btn-outline-success dropdown-toggle w-100" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-file-pdf"></i> Generate PDF Report
                        </button>
                        <ul class="dropdown-menu w-100">
                            {% for titulacion in titulaciones %}
                                <li><a class="dropdown-item" href="{% url 'generate_agenda_report_titulacion' titulacion.id %}">{{ titulacion.nombre }}</a></li>
                            {% endfor %}
                            {% if titulaciones|length > 1 %}
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{% url 'generate_agenda_report_all' %}"><strong>All Titulaciones</strong></a></li>
                            {% endif %}
                        </ul>
                    </div>
                    <a href="{% url 'ical_management' %}" class="btn btn-outline-warning">
                        <i class="bi bi-calendar-event"></i> Manage iCal Feeds
                    </a>
                </div>
            </div>
        </div>
        <div class="col-md-9">
             <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list-view" type="button" role="tab" aria-controls="list-view" aria-selected="true">Activity List</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#calendar-view" type="button" role="tab" aria-controls="calendar-view" aria-selected="false">Calendar View</button>
                </li>
            </ul>

            <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade show active" id="list-view" role="tabpanel" aria-labelledby="list-tab">
                    <div class="p-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3 class="mb-0">Filtered Activities</h3>
                            <span class="badge bg-secondary rounded-pill">{{ activities|length }} found</span>
                        </div>
                        <div class="table-responsive">
                            <h4 class="mt-4">Active Activities</h4>
                            <table class="table table-striped table-bordered table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Activity Name</th><th>Subjects</th><th>Type</th><th>Start Date</th><th>End Date</th><th>Evaluable</th><th>Percentage</th><th>Approved</th><th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for activity in active_activities %}
                                    <tr>
                                        <td>{{ activity.nombre }}</td>
                                        <td>{% for asignatura in activity.asignaturas.all %}{{ asignatura.nombre }}{% if not forloop.last %}, {% endif %}{% endfor %}</td>
                                        <td>{{ activity.tipo_actividad.nombre }}</td>
                                        <td>{{ activity.fecha_inicio|date:"d M Y, H:i" }}</td>
                                        <td>{{ activity.fecha_fin|date:"d M Y, H:i" }}</td>
                                        <td><input type="checkbox" {% if activity.evaluable %}checked{% endif %} disabled></td>
                                        <td>{{ activity.porcentaje_evaluacion }}%</td>
                                        <td class="approval-cell" data-activity-id="{{ activity.id }}">
                                            <input type="checkbox" 
                                                   class="form-check-input approval-checkbox" 
                                                   data-activity-id="{{ activity.id }}" 
                                                   {% if activity.aprobada %}checked{% endif %}>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <a href="{% url 'activity_details_readonly' activity.id %}" class="btn btn-outline-info" title="Ver detalles de la actividad" data-bs-toggle="tooltip" style="padding: 0.375rem 0.5rem;">
                                                    <i class="bi bi-eye" style="font-size: 1rem;"></i>
                                                </a>
                                                <a href="{% url 'activity_delete' activity.id %}" class="btn btn-outline-danger" title="Eliminar actividad" data-bs-toggle="tooltip" style="padding: 0.375rem 0.5rem;">
                                                    <i class="bi bi-trash" style="font-size: 1rem;"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="9" class="text-center">No active activities found.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>

                            <h4 class="mt-5">Deleted Activities</h4>
                            <table class="table table-striped table-bordered table-hover">
                                <thead class="table-secondary">
                                    <tr>
                                        <th>Activity Name</th><th>Subjects</th><th>Type</th><th>Start Date</th><th>End Date</th><th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for activity in inactive_activities %}
                                    <tr>
                                        <td>{{ activity.nombre }}</td>
                                        <td>{% for asignatura in activity.asignaturas.all %}{{ asignatura.nombre }}{% if not forloop.last %}, {% endif %}{% endfor %}</td>
                                        <td>{{ activity.tipo_actividad.nombre }}</td>
                                        <td>{{ activity.fecha_inicio|date:"d M Y, H:i" }}</td>
                                        <td>{{ activity.fecha_fin|date:"d M Y, H:i" }}</td>
                                        <td>
                                            <form action="{% url 'reactivate_activity' activity.pk %}" method="post" class="d-inline">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-outline-success" title="Restaurar actividad" data-bs-toggle="tooltip" style="padding: 0.375rem 0.5rem;">
                                                    <i class="bi bi-arrow-clockwise" style="font-size: 1rem;"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="6" class="text-center">No deleted activities found.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="calendar-view" role="tabpanel" aria-labelledby="calendar-tab">
                    <div class="p-3">
                         <h3 class="mb-3">Calendar</h3>
                        <div id='calendar'></div>
                    </div>
                </div>
            </div>
        </div>
        </div>
    {% endif %}

    <p class="mt-4">
        <form action="{% url 'logout' %}" method="post" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-secondary">Logout</button>
        </form>
    </p>
{% endblock %}

<!-- Activity Details Modal -->
<div class="modal fade" id="activityDetailModal" tabindex="-1" aria-labelledby="activityDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="activityDetailModalLabel">Activity Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Title:</strong> <span id="modalActivityTitle"></span></p>
                <p><strong>Description:</strong> <span id="modalActivityDescription"></span></p>
                <p><strong>Type:</strong> <span id="modalActivityType"></span></p>
                <p><strong>Subjects:</strong> <span id="modalActivitySubjects"></span></p>
                <p><strong>Start:</strong> <span id="modalActivityStart"></span></p>
                <p><strong>End:</strong> <span id="modalActivityEnd"></span></p>
                <p><strong>Approved:</strong> <span id="modalActivityApproved"></span></p>
                <p><strong>Active:</strong> <span id="modalActivityActive"></span></p>
                <p><strong>Evaluable:</strong> <span id="modalActivityEvaluable"></span></p>
                <p><strong>Percentage:</strong> <span id="modalActivityPercentage"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
    
    <script>
    // Utility function to format date in 24h format
    function formatDateTo24h(date) {
        const options = {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false // Force 24-hour format
        };
        return date.toLocaleDateString('es-ES', options);
    }

    document.addEventListener('DOMContentLoaded', function() {
        // --- 3. Inicialización de Tom Select ---
        new TomSelect('#titulacion',{ plugins: ['remove_button'], create: false });
        new TomSelect('#asignatura',{ plugins: ['remove_button'], create: false });
        new TomSelect('#curso',{ plugins: ['remove_button'], create: false });
        new TomSelect('#semestre',{ plugins: ['remove_button'], create: false });
        
        // --- LÓGICA DEL CALENDARIO (CORREGIDA) ---
        var calendarEl = document.getElementById('calendar');
        var isCalendarRendered = false;
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
            events: function(fetchInfo, successCallback, failureCallback) {
                const params = new URLSearchParams(new FormData(document.getElementById('filter-form')));
                fetch(`/all_activities/?${params.toString()}`)
                    .then(response => response.json()).then(data => successCallback(data)).catch(error => failureCallback(error));
            },
            eventClick: function(info) {
                // Populate modal with event details
                document.getElementById('modalActivityTitle').innerText = info.event.title;
                document.getElementById('modalActivityDescription').innerText = info.event.extendedProps.description || 'N/A';
                document.getElementById('modalActivityType').innerText = info.event.extendedProps.activity_type || 'N/A';
                document.getElementById('modalActivitySubjects').innerText = info.event.extendedProps.subjects || 'N/A';
                document.getElementById('modalActivityStart').innerText = info.event.start ? formatDateTo24h(info.event.start) : 'N/A';
                document.getElementById('modalActivityEnd').innerText = info.event.end ? formatDateTo24h(info.event.end) : 'N/A';
                document.getElementById('modalActivityApproved').innerText = info.event.extendedProps.is_approved ? 'Yes' : 'No';
                document.getElementById('modalActivityActive').innerText = info.event.extendedProps.is_active ? 'Yes' : 'No';
                document.getElementById('modalActivityEvaluable').innerText = info.event.extendedProps.evaluable ? 'Yes' : 'No';
                document.getElementById('modalActivityPercentage').innerText = info.event.extendedProps.percentage !== null ? info.event.extendedProps.percentage + '%' : 'N/A';

                // Show the modal
                var activityDetailModal = new bootstrap.Modal(document.getElementById('activityDetailModal'));
                activityDetailModal.show();
            }
        });

        var calendarTab = document.getElementById('calendar-tab');
        calendarTab.addEventListener('shown.bs.tab', function (event) {
            if (!isCalendarRendered) {
                calendar.render();
                isCalendarRendered = true;
            } else {
                calendar.refetchEvents();
            }
        });

        // --- SETUP APPROVAL CHECKBOXES WITH PERMISSIONS ---
        const userRole = '{{ user.role }}';
        const coordinatedTitulacionIds = {{ user_coordinated_titulaciones_ids|safe }};
        
        // Create activity to titulaciones mapping
        const activityTitulaciones = {};
        {% for activity in activities %}
            activityTitulaciones[{{ activity.id }}] = [
                {% for asignatura in activity.asignaturas.all %}
                    {{ asignatura.titulacion.id }}{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];
        {% endfor %}
        
        function canEditApproval(activityId) {
            // Admins can edit everything
            if (userRole === 'ADMIN') {
                return {
                    canEdit: true,
                    reason: 'Admin: Can approve/unapprove all activities'
                };
            }
            
            // Check if coordinator coordinates any titulacion involved in this activity
            const activityTitulacionIds = activityTitulaciones[activityId] || [];
            const hasPermission = activityTitulacionIds.some(titulacionId => 
                coordinatedTitulacionIds.includes(titulacionId)
            );
            
            if (hasPermission) {
                return {
                    canEdit: true,
                    reason: 'Coordinator: Can approve/unapprove activities in your coordinated titulaciones'
                };
            } else {
                return {
                    canEdit: false,
                    reason: 'Cannot edit: You don\'t coordinate any titulacion involved in this activity'
                };
            }
        }
        
        // Setup each approval checkbox
        document.querySelectorAll('.approval-checkbox').forEach(checkbox => {
            const activityId = parseInt(checkbox.dataset.activityId);
            const permission = canEditApproval(activityId);
            
            // Set tooltip
            checkbox.title = permission.reason;
            
            // Enable/disable based on permissions
            if (!permission.canEdit) {
                checkbox.disabled = true;
                checkbox.style.cursor = 'not-allowed';
                // Add visual indicator for disabled checkboxes
                checkbox.parentElement.style.opacity = '0.6';
            } else {
                checkbox.disabled = false;
                checkbox.style.cursor = 'pointer';
                
                // Add change event listener only for editable checkboxes
                checkbox.addEventListener('change', function() {
                    const isApproved = this.checked;
                    const originalState = !isApproved; // Store original state for rollback
                    
                    // Disable checkbox during request
                    this.disabled = true;
                    
                    fetch(`/activity/toggle_approval_from_dashboard/${activityId}/`, {
                        method: 'POST',
                        headers: { 
                            'X-CSRFToken': '{{ csrf_token }}', 
                            'Content-Type': 'application/json' 
                        },
                        body: JSON.stringify({ 'aprobada': isApproved })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (!data.success) {
                            alert('Failed to update approval status');
                            this.checked = originalState; // Rollback
                        }
                        // Re-enable checkbox
                        this.disabled = false;
                    })
                    .catch(error => {
                        console.error('Error toggling approval status:', error);
                        alert('Error updating approval status.');
                        this.checked = originalState; // Rollback
                        this.disabled = false; // Re-enable
                    });
                });
            }
        });

        const titulacionSelect = document.getElementById('titulacion');
        const cursoSelect = document.getElementById('curso');
        const asignaturaSelect = document.getElementById('asignatura');

        function updateAsignaturas() {
            // Tom Select usa un objeto API, así que obtenemos los valores de su instancia
            const tsTitulacion = titulacionSelect.tomselect;
            const tsCurso = cursoSelect.tomselect;
            const selectedTitulaciones = tsTitulacion.getValue();
            const selectedCursos = tsCurso.getValue();
            
            const params = new URLSearchParams();
            selectedTitulaciones.forEach(id => params.append('titulacion_ids', id));
            selectedCursos.forEach(id => params.append('curso_ids', id));
            fetch(`/ajax/get_filtered_asignaturas/?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    const tsAsignatura = asignaturaSelect.tomselect;
                    const selected = tsAsignatura.getValue();
                    tsAsignatura.clearOptions();
                    tsAsignatura.addOptions(data.map(asignatura => ({value: asignatura.id, text: asignatura.nombre})));
                    tsAsignatura.setValue(selected); // Re-seleccionar lo que estuviera antes si aún existe
                });
        }

        if (titulacionSelect.tomselect && cursoSelect.tomselect) {
            titulacionSelect.tomselect.on('change', updateAsignaturas);
            cursoSelect.tomselect.on('change', updateAsignaturas);
            updateAsignaturas();
        }

        document.getElementById('filter-form').addEventListener('submit', function() {
            const btn = this.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Filtering...`;
        });

        // Initialize tooltips for action buttons
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function(tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
    </script>
{% endblock %}