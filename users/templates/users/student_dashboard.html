{% extends 'base.html' %}

{% block title %}Student Dashboard{% endblock %}

{% block extra_head %}
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
    <style>
        @media (min-width: 768px) {
            .sidebar {
                position: sticky;
                top: 1rem;
                height: calc(100vh - 2rem);
            }
        }
        /* Hacemos que Tom Select en modo disabled parezca un display de etiquetas */
        .ts-wrapper.disabled .ts-control {
            background-color: #e9ecef;
            opacity: 0.8;
            cursor: default;
        }
        .ts-wrapper.disabled .ts-control > div {
             cursor: default;
        }
    </style>
{% endblock %}

{% block content %}
    <h2 class="my-4">Student Dashboard</h2>
    <p class="lead">Welcome, Student!</p>

    <div class="row mt-4">
        <div class="col-md-3">
            <div class="sidebar p-3 bg-light rounded">
                <h4 class="mb-3">Actions</h4>
                <div class="d-grid gap-2">
                    <a href="{% url 'select_subjects' %}" class="btn btn-primary">Select/Update Subjects</a>
                </div>

                <hr class="my-4">

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0">My Enrolled Subjects</h4>
                    <button class="btn btn-outline-secondary btn-sm" onclick="toggleAllSubjects()" id="toggleAllBtn">Select All</button>
                </div>
                
                {% if enrolled_subjects %}
                    <div class="table-responsive mb-3" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm">
                            <tbody>
                                {% for subject in enrolled_subjects %}
                                <tr>
                                    <td class="align-middle">
                                        <div class="form-check">
                                            <input class="form-check-input subject-checkbox" type="checkbox" name="selected_subjects" value="{{ subject.id }}" id="subject_{{ subject.id }}" {% if subject.id|stringformat:"s" in selected_asignaturas %}checked{% endif %}>
                                            <label class="form-check-label" for="subject_{{ subject.id }}">
                                                {{ subject.nombre }}
                                            </label>
                                        </div>
                                    </td>
                                    <td class="text-muted small align-middle">{{ subject.titulacion.nombre }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted small">You are not enrolled in any subjects yet. Click the button above to select them.</p>
                {% endif %}

                <hr class="my-4">

                <div class="accordion" id="icalAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingIcal">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseIcal" aria-expanded="false" aria-controls="collapseIcal">
                                iCal Feed Configurations
                            </button>
                        </h2>
                        <div id="collapseIcal" class="accordion-collapse collapse" aria-labelledby="headingIcal" data-bs-parent="#icalAccordion">
                            <div class="accordion-body">
                                {% if calendar_views %}
                                <ul class="list-group">
                                    {% for view in calendar_views %}
                                    <li class="list-group-item">
                                        <strong>{{ view.nombre }}</strong>
                                        <div class="mt-2">
                                            <button class="btn btn-sm btn-outline-secondary copyIcalLinkBtn" data-ical-url="{{ request.scheme }}://{{ request.get_host }}{% url 'ical_feed' view.token %}">Copy Link</button>
                                            <a href="{% url 'delete_calendar_view' view.pk %}" class="btn btn-sm btn-outline-danger ms-1">Delete</a>
                                        </div>
                                    </li>
                                    {% endfor %}
                                </ul>
                                {% else %}
                                <p class="text-muted small">No iCal feed configurations found.</p>
                                {% endif %}
                                <a href="{% url 'student_ical_config' %}" class="btn btn-secondary btn-sm mt-3">Create New iCal Feed</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list-view" type="button" role="tab" aria-controls="list-view" aria-selected="true">Activity List</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#calendar-view" type="button" role="tab" aria-controls="calendar-view" aria-selected="false">Calendar View</button>
                </li>
            </ul>

            <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade show active p-3" id="list-view" role="tabpanel" aria-labelledby="list-tab">
                    <h3 class="mb-3">Upcoming Activities</h3>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Activity</th>
                                    <th>Subject</th>
                                    <th>Type</th>
                                    <th>Start Date</th>
                                    <th>End Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for activity in activities %}
                                <tr>
                                    <td>{{ activity.nombre }}</td>
                                    <td>
                                        {% for asignatura in activity.asignaturas.all %}
                                            {{ asignatura.nombre }}{% if not forloop.last %}, {% endif %}
                                        {% endfor %}
                                    </td>
                                    <td>{{ activity.tipo_actividad.nombre }}</td>
                                    <td>{{ activity.fecha_inicio|date:"D, d M Y, H:i" }}</td>
                                    <td>{{ activity.fecha_fin|date:"D, d M Y, H:i" }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center">No activities found for your selected subjects.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade p-3" id="calendar-view" role="tabpanel" aria-labelledby="calendar-tab">
                    <h3 class="mb-3">Your Calendar</h3>
                    <div id='calendar'></div>
                </div>
            </div>
        </div>
    </div>

    <p class="mt-4">
        <form action="{% url 'logout' %}" method="post" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-secondary">Logout</button>
        </form>
    </p>
{% endblock %}

<!-- Activity Details Modal -->
<div class="modal fade" id="activityDetailModal" tabindex="-1" aria-labelledby="activityDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="activityDetailModalLabel">Activity Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Title:</strong> <span id="modalActivityTitle"></span></p>
                <p><strong>Description:</strong> <span id="modalActivityDescription"></span></p>
                <p><strong>Type:</strong> <span id="modalActivityType"></span></p>
                <p><strong>Subjects:</strong> <span id="modalActivitySubjects"></span></p>
                <p><strong>Start:</strong> <span id="modalActivityStart"></span></p>
                <p><strong>End:</strong> <span id="modalActivityEnd"></span></p>
                <p><strong>Approved:</strong> <span id="modalActivityApproved"></span></p>
                <p><strong>Active:</strong> <span id="modalActivityActive"></span></p>
                <p><strong>Evaluable:</strong> <span id="modalActivityEvaluable"></span></p>
                <p><strong>Percentage:</strong> <span id="modalActivityPercentage"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <script>
    // Utility function to format date in 24h format
    function formatDateTo24h(date) {
        const options = {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false // Force 24-hour format
        };
        return date.toLocaleDateString('es-ES', options);
    }

    document.addEventListener('DOMContentLoaded', function() {
        // --- LÓGICA DEL CALENDARIO ---
        var calendarEl = document.getElementById('calendar');
        var isCalendarRendered = false;
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,listWeek'
            },
            events: function(fetchInfo, successCallback, failureCallback) {
                // Get currently selected subjects
                const checkedSubjects = Array.from(document.querySelectorAll('.subject-checkbox:checked'))
                    .map(cb => cb.value);
                
                // Build URL with current filters
                const url = new URL("{% url 'student_calendar_events' %}", window.location.origin);
                checkedSubjects.forEach(subjectId => {
                    url.searchParams.append('asignatura', subjectId);
                });
                
                // Fetch events
                fetch(url.toString())
                    .then(response => response.json())
                    .then(data => successCallback(data))
                    .catch(error => failureCallback(error));
            },
            eventClick: function(info) {
                // Populate modal with event details
                document.getElementById('modalActivityTitle').innerText = info.event.title;
                document.getElementById('modalActivityDescription').innerText = info.event.extendedProps.description || 'N/A';
                document.getElementById('modalActivityType').innerText = info.event.extendedProps.activity_type || 'N/A';
                document.getElementById('modalActivitySubjects').innerText = info.event.extendedProps.subjects || 'N/A';
                document.getElementById('modalActivityStart').innerText = info.event.start ? formatDateTo24h(info.event.start) : 'N/A';
                document.getElementById('modalActivityEnd').innerText = info.event.end ? formatDateTo24h(info.event.end) : 'N/A';
                document.getElementById('modalActivityApproved').innerText = info.event.extendedProps.is_approved ? 'Yes' : 'No';
                document.getElementById('modalActivityActive').innerText = info.event.extendedProps.is_active ? 'Yes' : 'No';
                document.getElementById('modalActivityEvaluable').innerText = info.event.extendedProps.evaluable ? 'Yes' : 'No';
                document.getElementById('modalActivityPercentage').innerText = info.event.extendedProps.percentage !== null ? info.event.extendedProps.percentage + '%' : 'N/A';

                // Show the modal
                var activityDetailModal = new bootstrap.Modal(document.getElementById('activityDetailModal'));
                activityDetailModal.show();
            }
        });

        var calendarTab = document.getElementById('calendar-tab');
        calendarTab.addEventListener('shown.bs.tab', function (event) {
            if (!isCalendarRendered) {
                calendar.render();
                isCalendarRendered = true;
            } else {
                calendar.refetchEvents();
            }
        });

        // --- FILTRADO POR ASIGNATURAS ---
        const subjectCheckboxes = document.querySelectorAll('.subject-checkbox');
        
        // Apply filters when checkboxes change
        subjectCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                applySubjectFilters();
            });
        });

        function applySubjectFilters() {
            const checkedSubjects = Array.from(subjectCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            
            // Build URL with selected subjects
            const url = new URL(window.location.href);
            url.searchParams.delete('asignatura'); // Clear existing
            checkedSubjects.forEach(subjectId => {
                url.searchParams.append('asignatura', subjectId);
            });
            
            // Update calendar if rendered
            if (isCalendarRendered && calendar) {
                calendar.refetchEvents();
            }
            
            // Reload page with new filters
            window.location.href = url.toString();
        }

        // Copy iCal link functionality
        document.querySelectorAll('.copyIcalLinkBtn').forEach(button => {
            button.addEventListener('click', function() {
                const icalUrl = this.getAttribute('data-ical-url');
                navigator.clipboard.writeText(icalUrl).then(() => {
                    // Show feedback
                    const originalText = this.textContent;
                    this.textContent = 'Copied!';
                    this.classList.add('btn-success');
                    this.classList.remove('btn-outline-secondary');
                    
                    setTimeout(() => {
                        this.textContent = originalText;
                        this.classList.remove('btn-success');
                        this.classList.add('btn-outline-secondary');
                    }, 2000);
                }).catch(err => {
                    alert('Failed to copy: ' + err);
                });
            });
        });
    });

    // Toggle all subjects function (called by button)
    function toggleAllSubjects() {
        const checkboxes = document.querySelectorAll('.subject-checkbox');
        const toggleBtn = document.getElementById('toggleAllBtn');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        
        checkboxes.forEach(cb => {
            cb.checked = !allChecked;
        });
        
        toggleBtn.textContent = allChecked ? 'Select All' : 'Deselect All';
        
        // Apply filters after toggling
        const event = new Event('change');
        checkboxes[0]?.dispatchEvent(event);
    }
    </script>
{% endblock %}